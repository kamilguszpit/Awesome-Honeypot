input {
    beats {
        port => 5044
        # Typ ustawiamy tutaj, aby filtry poniżej zadziałały
        type => "cowrie"
    }
}

filter {
    if [type] == "cowrie" {
        # Usuwamy problematyczne pole input, jeśli istnieje
        mutate {
            remove_field => [ "input" ]
        }

        # Parsowanie logu JSON z Cowrie
        json {
            source => "message"
        }

        # Standaryzacja czasu
        date {
            match => [ "@timestamp", "ISO8601" ]
        }

        if [src_ip] {
            # Przygotowanie pola pod DNS
            mutate {
                add_field => { "src_host" => "%{src_ip}" }
            }

            # Próba reverse DNS (to zadziała bez plików zewnętrznych)
            dns {
                reverse => [ "src_host" ]
                nameserver => [ "8.8.8.8", "8.8.4.4" ]
                action => "replace"
                hit_cache_size => 4096
                hit_cache_ttl => 900
                failed_cache_size => 512
                failed_cache_ttl => 900
            }

            # SEKCJA GEOIP ZOSTAŁA USUNIĘTA - to ona powodowała błędy
        }
        
        # Sprzątanie zbędnych metadanych
        mutate {
            remove_tag => [ "beats_input_codec_plain_applied"]
            remove_field => [ "[log][file][path]", "[log][offset]", "message" ]
        }
    }
}

output {
    if [type] == "cowrie" {
        elasticsearch {
            hosts => ["http://elasticsearch:9200"]
            index => "cowrie-logstash-%{+YYYY.MM.dd}"
        }
        # Debugging w logach kontenera (możesz usunąć po testach)
        stdout {
            codec => rubydebug
        }
    }
}
